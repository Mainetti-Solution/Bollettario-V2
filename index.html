
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Mainetti Solution - Bollettario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- jsPDF per generare il PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

  <style>
    :root {
      --bg: #0b1120;
      --card: #020617;
      --accent: #22c55e;
      --accent-soft: #16a34a22;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --danger: #dc2626;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top, #1f2937 0, #020617 45%, #000 100%);
      color: var(--text);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .logo {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }

    .logo-title {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .logo-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
      letter-spacing: 0.08em;
    }

    .pill {
      border-radius: 999px;
      padding: 0.35rem 0.7rem;
      font-size: 0.7rem;
      border: 1px solid var(--border);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      background: #020617aa;
      backdrop-filter: blur(8px);
    }

    .pill span {
      font-size: 0.9em;
    }

    main {
      display: grid;
      grid-template-columns: 2fr 1.3fr;
      gap: 1rem;
    }

    @media (max-width: 800px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: linear-gradient(135deg, #020617ee, #020617ee);
      border-radius: 1rem;
      border: 1px solid var(--border);
      padding: 0.9rem;
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.75),
        0 0 0 1px rgba(148, 163, 184, 0.08);
    }

    h2 {
      margin: 0 0 0.6rem;
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    h3 {
      font-size: 0.85rem;
      margin: 0.8rem 0 0.45rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .section-desc {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .grid {
      display: grid;
      gap: 0.6rem;
    }

    .grid-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .grid-3 {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }

    @media (max-width: 600px) {
      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }

    label {
      display: block;
      font-size: 0.75rem;
      margin-bottom: 0.2rem;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    textarea,
    select {
      width: 100%;
      padding: 0.45rem 0.55rem;
      border-radius: 0.7rem;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 0.8rem;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input::placeholder,
    textarea::placeholder {
      color: #4b5563;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: #020617;
    }

    textarea {
      resize: vertical;
      min-height: 60px;
      max-height: 160px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th,
    td {
      padding: 0.4rem 0.35rem;
      border-bottom: 1px solid #111827;
    }

    th {
      text-align: left;
      color: var(--text-muted);
      font-weight: 500;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    td:last-child,
    th:last-child {
      text-align: right;
    }

    .material-total-cell {
      text-align: right;
      font-variant-numeric: tabular-nums;
      color: var(--text-muted);
    }

    .materials-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.4rem;
      gap: 0.5rem;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.4rem 0.9rem;
      font-size: 0.78rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      background: var(--accent);
      color: #022c22;
      transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
      box-shadow: 0 8px 16px rgba(34, 197, 94, 0.25);
      white-space: nowrap;
    }

    .btn:hover {
      background: #16a34a;
      transform: translateY(-0.5px);
      box-shadow: 0 14px 28px rgba(34, 197, 94, 0.25);
    }

    .btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 12px rgba(34, 197, 94, 0.25);
    }

    .btn-outline {
      background: transparent;
      color: var(--text);
      border-color: #1f2937;
      box-shadow: none;
    }

    .btn-outline:hover {
      background: #020617;
    }

    .btn-ghost {
      background: transparent;
      border-color: transparent;
      color: var(--text-muted);
      padding-inline: 0.4rem;
      box-shadow: none;
    }

    .btn-ghost:hover {
      background: #020617;
      color: var(--danger);
    }

    .btn-sm {
      padding: 0.35rem 0.7rem;
      font-size: 0.72rem;
    }

    .totals {
      border-radius: 0.9rem;
      padding: 0.6rem 0.75rem;
      background: radial-gradient(circle at top left, #16a34a11, #020617 55%);
      border: 1px solid #1f2937;
      margin-top: 0.5rem;
    }

    .totals-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.8rem;
      margin-bottom: 0.1rem;
    }

    .totals-row span:last-child {
      font-variant-numeric: tabular-nums;
    }

    .totals-row.total {
      margin-top: 0.25rem;
      padding-top: 0.25rem;
      border-top: 1px solid #111827;
      font-weight: 600;
      color: var(--accent);
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      color: var(--text-muted);
      background: #020617;
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      max-height: 70vh;
      overflow-y: auto;
    }

    .ticket {
      border-radius: 0.8rem;
      border: 1px solid #1f2937;
      background: #020617aa;
      padding: 0.55rem 0.65rem;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.78rem;
    }

    .ticket-main {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
    }

    .ticket-title {
      font-weight: 500;
    }

    .ticket-sub {
      color: var(--text-muted);
      font-size: 0.7rem;
    }

    .ticket-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.15rem;
    }

    details {
      margin-top: 0.2rem;
    }

    summary {
      cursor: pointer;
      color: var(--text-muted);
      font-size: 0.72rem;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    summary::before {
      content: "‚ñ∂";
      display: inline-block;
      margin-right: 0.25rem;
      font-size: 0.6rem;
    }

    details[open] summary::before {
      content: "‚ñº";
    }

    .materials-preview {
      margin-top: 0.35rem;
    }

    .materials-preview li {
      margin-bottom: 0.2rem;
    }

    .helper {
      font-size: 0.7rem;
      color: var(--text-muted);
    }

    .helper-strong {
      color: var(--accent);
      font-weight: 500;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-bottom: 0.4rem;
    }

    .chip {
      font-size: 0.7rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: #020617;
      color: var(--text-muted);
    }

    /* Firma cliente */
    .signature-wrapper {
      margin-top: 0.6rem;
    }

    .signature-box {
      border-radius: 0.9rem;
      border: 1px dashed #374151;
      background: #020617;
      padding: 0.4rem;
    }

    #signaturePad {
      display: block;
      width: 100%;
      height: 140px;
      border-radius: 0.6rem;
      background: #000;
      touch-action: none;
    }

    .signature-actions {
      margin-top: 0.35rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    .signature-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">
        <div class="logo-title">Mainetti Solution</div>
        <div class="logo-sub">Bollettario interventi</div>
      </div>
      <div class="pill">
        <span>üì±</span>
        <span>Installa come app</span>
      </div>
    </header>

    <main>
      <!-- COLONNA SINISTRA: FORM BOLLETTINO -->
      <section class="card">
        <h2>
          Nuovo bollettino
          <span class="badge" id="draftInfo">Bozza non salvata</span>
        </h2>

        <div class="chip-row">
          <div class="chip">‚ö° Compila fine lavoro</div>
          <div class="chip">üïí Calcolo ore automatico</div>
          <div class="chip">üíæ Salva su questo telefono</div>
        </div>

        <form id="ticketForm">
          <h3>Dati intervento</h3>
          <p class="section-desc">
            Informazioni base del lavoro svolto.
          </p>
          <div class="grid grid-2">
            <div>
              <label for="collaborator">Collaboratore</label>
              <input type="text" id="collaborator" placeholder="Es. Aaron" />
            </div>
            <div>
              <label for="client">Cliente</label>
              <input type="text" id="client" placeholder="Nome cliente o ditta" />
            </div>
          </div>

          <div class="grid grid-2">
            <div>
              <label for="location">Luogo</label>
              <input type="text" id="location" placeholder="Es. Cresciano, via..." />
            </div>
            <div>
              <label for="date">Data</label>
              <input type="date" id="date" />
            </div>
          </div>

          <div class="grid grid-3">
            <div>
              <label for="startTime">Ora inizio</label>
              <input type="time" id="startTime" />
            </div>
            <div>
              <label for="endTime">Ora fine</label>
              <input type="time" id="endTime" />
            </div>
            <div>
              <label for="hourlyRate">Tariffa oraria (CHF)</label>
              <input type="number" id="hourlyRate" min="0" step="0.05" placeholder="Es. 80" />
            </div>
          </div>

          <div style="margin-top: 0.6rem;">
            <label for="activity">Attivit√† svolta</label>
            <textarea id="activity" placeholder="Descrizione sintetica dell'intervento"></textarea>
          </div>

          <div style="margin-top: 0.4rem;">
            <label for="notes">Note interne (opzionale)</label>
            <textarea id="notes" placeholder="Note per te / Mainetti Solution, non per il cliente"></textarea>
          </div>

          <h3 style="margin-top: 1rem;">Materiale utilizzato</h3>
          <p class="section-desc">
            Inserisci il materiale con quantit√† e prezzo unitario.
          </p>

          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Materiale</th>
                  <th>Q.t√†</th>
                  <th>Prezzo (CHF)</th>
                  <th>Totale</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="materialsBody">
                <!-- Righe dinamiche -->
              </tbody>
            </table>
          </div>

          <div class="materials-footer">
            <button type="button" class="btn btn-sm btn-outline" id="addMaterialRow">
              ‚ûï Aggiungi riga
            </button>
            <span class="helper">
              Lascia vuote le righe non utilizzate.
            </span>
          </div>

          <div class="totals">
            <div class="totals-row">
              <span>Ore lavorate</span>
              <span id="hoursWorked">0.00 h</span>
            </div>
            <div class="totals-row">
              <span>Costo manodopera</span>
              <span id="laborCost">CHF 0.00</span>
            </div>
            <div class="totals-row">
              <span>Materiali</span>
              <span id="materialsTotal">CHF 0.00</span>
            </div>
            <div class="totals-row total">
              <span>Totale intervento</span>
              <span id="grandTotal">CHF 0.00</span>
            </div>
          </div>

          <!-- FIRMA CLIENTE -->
          <div class="signature-wrapper">
            <h3>Firma cliente</h3>
            <p class="section-desc">
              Fai firmare il cliente sul display al momento della chiusura del lavoro.
            </p>
            <div class="signature-box">
              <canvas id="signaturePad"></canvas>
              <div class="signature-actions">
                <span class="signature-hint">‚úçÔ∏è Firma con il dito (o mouse)</span>
                <button type="button" class="btn btn-sm btn-outline" id="clearSignatureBtn">
                  Pulisci firma
                </button>
              </div>
            </div>
          </div>

          <div style="margin-top: 0.7rem; display:flex; gap:0.5rem; flex-wrap:wrap;">
            <button type="button" class="btn" id="saveTicketBtn">
              üíæ Salva bollettino
            </button>
            <button type="button" class="btn btn-outline" id="generatePdfBtn">
              üìÑ PDF bollettino
            </button>
            <button type="button" class="btn btn-outline" id="resetFormBtn">
              üßπ Svuota campi
            </button>
          </div>
          <p class="helper" style="margin-top:0.4rem;">
            I bollettini sono salvati in locale su questo dispositivo.
          </p>
        </form>
      </section>

      <!-- COLONNA DESTRA: STORICO -->
      <section class="card">
        <div class="history-header">
          <h2>Storico bollettini</h2>
          <div style="display:flex; gap:0.35rem; flex-wrap:wrap;">
            <button type="button" class="btn btn-sm btn-outline" id="importBtn">
              üì• Importa JSON
            </button>
            <button type="button" class="btn btn-sm btn-outline" id="exportBtn">
              ‚¨áÔ∏è Esporta JSON
            </button>
            <button type="button" class="btn btn-sm btn-ghost" id="clearAllBtn" title="Cancella tutto">
              üóë
            </button>
          </div>
        </div>
        <p class="section-desc">
          Elenco dei bollettini salvati su questo telefono.
        </p>
        <div class="history-list" id="ticketsList">
          <!-- Bollettini dinamici -->
        </div>

        <!-- input file nascosto per import JSON -->
        <input type="file" id="importFileInput" accept="application/json" style="display:none;" />
      </section>
    </main>

    <p class="helper" style="margin-top:0.8rem; text-align:center;">
      Suggerimento: dal browser del telefono usa
      <span class="helper-strong">‚ÄúAggiungi alla schermata Home‚Äù</span> per usarla come app.
    </p>
  </div>

  <script>
    const STORAGE_KEY = "ms_bollettini";

    function formatMoney(value) {
      const num = Number.isFinite(value) ? value : 0;
      return "CHF " + num.toFixed(2);
    }

    function calculateHours(start, end) {
      if (!start || !end) return 0;
      const [sh, sm] = start.split(":").map(Number);
      const [eh, em] = end.split(":").map(Number);
      let startMinutes = sh * 60 + sm;
      let endMinutes = eh * 60 + em;
      if (Number.isNaN(startMinutes) || Number.isNaN(endMinutes)) return 0;
      if (endMinutes < startMinutes) {
        endMinutes += 24 * 60;
      }
      const diffMinutes = endMinutes - startMinutes;
      return diffMinutes / 60;
    }

    function createMaterialRow() {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const inputName = document.createElement("input");
      inputName.type = "text";
      inputName.placeholder = "Descrizione";
      inputName.classList.add("material-name");
      tdName.appendChild(inputName);

      const tdQty = document.createElement("td");
      const inputQty = document.createElement("input");
      inputQty.type = "number";
      inputQty.min = "0";
      inputQty.step = "0.01";
      inputQty.placeholder = "0";
      inputQty.classList.add("material-qty");
      tdQty.appendChild(inputQty);

      const tdPrice = document.createElement("td");
      const inputPrice = document.createElement("input");
      inputPrice.type = "number";
      inputPrice.min = "0";
      inputPrice.step = "0.05";
      inputPrice.placeholder = "0.00";
      inputPrice.classList.add("material-price");
      tdPrice.appendChild(inputPrice);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = "0.00";
      tdTotal.classList.add("material-total-cell");

      const tdActions = document.createElement("td");
      const btnRemove = document.createElement("button");
      btnRemove.type = "button";
      btnRemove.className = "btn btn-ghost btn-sm";
      btnRemove.textContent = "‚úï";
      tdActions.appendChild(btnRemove);

      tr.appendChild(tdName);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdTotal);
      tr.appendChild(tdActions);

      function recalcRow() {
        const qty = parseFloat(inputQty.value) || 0;
        const price = parseFloat(inputPrice.value) || 0;
        const total = qty * price;
        tdTotal.textContent = total.toFixed(2);
        updateTotals();
      }

      inputQty.addEventListener("input", recalcRow);
      inputPrice.addEventListener("input", recalcRow);

      btnRemove.addEventListener("click", () => {
        tr.remove();
        updateTotals();
      });

      return tr;
    }

    function getMaterialsFromTable() {
      const rows = document.querySelectorAll("#materialsBody tr");
      const materials = [];
      rows.forEach((row) => {
        const name = row.querySelector(".material-name")?.value?.trim() || "";
        const qty = parseFloat(row.querySelector(".material-qty")?.value) || 0;
        const price = parseFloat(row.querySelector(".material-price")?.value) || 0;
        if (name || qty || price) {
          materials.push({
            name,
            qty,
            price,
            total: qty * price,
          });
        }
      });
      return materials;
    }

    function updateTotals() {
      const start = document.getElementById("startTime").value;
      const end = document.getElementById("endTime").value;
      const rate = parseFloat(document.getElementById("hourlyRate").value) || 0;

      const hours = calculateHours(start, end);
      const laborCost = hours * rate;

      const materials = getMaterialsFromTable();
      const materialsTotal = materials.reduce((sum, m) => sum + m.total, 0);

      document.getElementById("hoursWorked").textContent = hours.toFixed(2) + " h";
      document.getElementById("laborCost").textContent = formatMoney(laborCost);
      document.getElementById("materialsTotal").textContent = formatMoney(materialsTotal);
      document.getElementById("grandTotal").textContent = formatMoney(laborCost + materialsTotal);

      document.getElementById("draftInfo").textContent = "Bozza non salvata";
    }

    function loadTickets() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : [];
      } catch (e) {
        console.error("Errore lettura storage", e);
        return [];
      }
    }

    function saveTickets(tickets) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tickets));
    }

    function renderTicketsList() {
      const container = document.getElementById("ticketsList");
      const tickets = loadTickets();
      container.innerHTML = "";

      if (!tickets.length) {
        const p = document.createElement("p");
        p.className = "helper";
        p.textContent = "Nessun bollettino salvato ancora.";
        container.appendChild(p);
        return;
      }

      tickets
        .slice()
        .reverse()
        .forEach((ticket) => {
          const card = document.createElement("div");
          card.className = "ticket";

          const main = document.createElement("div");
          main.className = "ticket-main";

          const left = document.createElement("div");
          const title = document.createElement("div");
          title.className = "ticket-title";
          title.textContent = ticket.client || "Cliente non indicato";
          const sub = document.createElement("div");
          sub.className = "ticket-sub";
          const d = ticket.date || "";
          const loc = ticket.location || "";
          sub.textContent = [d, loc].filter(Boolean).join(" ‚Ä¢ ");
          left.appendChild(title);
          left.appendChild(sub);

          const right = document.createElement("div");
          right.style.textAlign = "right";
          const totalEl = document.createElement("div");
          totalEl.style.fontWeight = "600";
          totalEl.textContent = formatMoney(ticket.totals?.grandTotal || 0);
          const hoursEl = document.createElement("div");
          hoursEl.className = "ticket-sub";
          const h = ticket.totals?.hours || 0;
          hoursEl.textContent = h ? h.toFixed(2) + " h" : "-";
          right.appendChild(totalEl);
          right.appendChild(hoursEl);

          main.appendChild(left);
          main.appendChild(right);
          card.appendChild(main);

          const footer = document.createElement("div");
          footer.className = "ticket-footer";

          const coll = document.createElement("div");
          coll.className = "ticket-sub";
          coll.textContent = ticket.collaborator ? "üë∑ " + ticket.collaborator : "üë∑ -";
          footer.appendChild(coll);

          const buttons = document.createElement("div");
          buttons.style.display = "flex";
          buttons.style.gap = "0.35rem";

          const details = document.createElement("details");
          const summary = document.createElement("summary");
          summary.textContent = "Dettagli";
          details.appendChild(summary);

          const detailsBody = document.createElement("div");
          detailsBody.style.marginTop = "0.25rem";
          detailsBody.style.fontSize = "0.72rem";
          detailsBody.innerHTML = `
            <div><strong>Attivit√†:</strong> ${ticket.activity || "-"}</div>
            <div><strong>Orari:</strong> ${ticket.startTime || "-"} ‚Üí ${ticket.endTime || "-"}</div>
            <div class="materials-preview">
              <strong>Materiali:</strong>
              ${
                ticket.materials && ticket.materials.length
                  ? "<ul>" +
                    ticket.materials
                      .map(
                        (m) =>
                          `<li>${(m.name || "Materiale").replace(
                            /</g,
                            "&lt;"
                          )} ‚Äì ${m.qty} √ó ${m.price.toFixed(2)} = ${m.total.toFixed(2)}</li>`
                      )
                      .join("") +
                    "</ul>"
                  : "nessun materiale"
              }
            </div>
          `;
          details.appendChild(detailsBody);
          buttons.appendChild(details);

          const copyBtn = document.createElement("button");
          copyBtn.type = "button";
          copyBtn.className = "btn btn-ghost btn-sm";
          copyBtn.textContent = "üìã Copia";
          copyBtn.title = "Copia riepilogo testuale";
          copyBtn.addEventListener("click", () => {
            const text = [
              `Cliente: ${ticket.client || "-"}`,
              `Collaboratore: ${ticket.collaborator || "-"}`,
              `Luogo: ${ticket.location || "-"}`,
              `Data: ${ticket.date || "-"}`,
              `Orario: ${ticket.startTime || "-"} ‚Üí ${ticket.endTime || "-"}`,
              `Ore: ${ticket.totals?.hours.toFixed(2) || "0.00"}`,
              `Totale: ${formatMoney(ticket.totals?.grandTotal || 0)}`,
              `Attivit√†: ${ticket.activity || "-"}`,
            ].join("\n");
            navigator.clipboard
              .writeText(text)
              .catch((e) => console.error("Clipboard error", e));
          });
          buttons.appendChild(copyBtn);

          footer.appendChild(buttons);
          card.appendChild(footer);

          container.appendChild(card);
        });
    }

    function collectFormData(includeSignature = false) {
      const materials = getMaterialsFromTable();
      const start = document.getElementById("startTime").value;
      const end = document.getElementById("endTime").value;
      const rate = parseFloat(document.getElementById("hourlyRate").value) || 0;
      const hours = calculateHours(start, end);
      const laborCost = hours * rate;
      const materialsTotal = materials.reduce((sum, m) => sum + m.total, 0);

      let signatureDataUrl = null;
      if (includeSignature && signatureDirty) {
        const canvas = document.getElementById("signaturePad");
        signatureDataUrl = canvas.toDataURL("image/png");
      }

      return {
        id: Date.now(),
        createdAt: new Date().toISOString(),
        collaborator: document.getElementById("collaborator").value.trim(),
        client: document.getElementById("client").value.trim(),
        location: document.getElementById("location").value.trim(),
        date: document.getElementById("date").value,
        startTime: start,
        endTime: end,
        hourlyRate: rate,
        activity: document.getElementById("activity").value.trim(),
        notes: document.getElementById("notes").value.trim(),
        materials,
        signature: signatureDataUrl,
        totals: {
          hours,
          laborCost,
          materialsTotal,
          grandTotal: laborCost + materialsTotal,
        },
      };
    }

    function resetForm() {
      document.getElementById("ticketForm").reset();
      const body = document.getElementById("materialsBody");
      body.innerHTML = "";
      for (let i = 0; i < 3; i++) {
        body.appendChild(createMaterialRow());
      }
      clearSignature();
      updateTotals();
      document.getElementById("draftInfo").textContent = "Bozza pulita";
    }

    function exportTickets() {
      const tickets = loadTickets();
      if (!tickets.length) {
        alert("Nessun bollettino da esportare.");
        return;
      }
      const blob = new Blob([JSON.stringify(tickets, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      const stamp = new Date().toISOString().slice(0, 10);
      a.download = `mainetti-bollettini-${stamp}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ---- IMPORT JSON ----
    function handleImportFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const text = e.target.result;
          const parsed = JSON.parse(text);

          let importedTickets = [];
          if (Array.isArray(parsed)) {
            importedTickets = parsed;
          } else if (parsed && typeof parsed === "object") {
            importedTickets = [parsed];
          } else {
            alert("Formato JSON non valido.");
            return;
          }

          const existing = loadTickets();
          const mergedById = new Map();

          existing.forEach((t) => {
            mergedById.set(t.id || `${t.client}-${t.date}-${t.startTime}`, t);
          });

          importedTickets.forEach((t) => {
            const key = t.id || `${t.client}-${t.date}-${t.startTime}`;
            mergedById.set(key, t);
          });

          const merged = Array.from(mergedById.values());
          saveTickets(merged);
          renderTicketsList();
          alert(`Import completato: ${importedTickets.length} bollettino/i aggiunto/i.`);
        } catch (err) {
          console.error("Errore import JSON", err);
          alert("Errore durante l'import. Verifica che il file sia stato esportato dal bollettario.");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file, "utf-8");
    }

    // ---- GESTIONE FIRMA ----
    let signatureDirty = false;

    function setupSignaturePad() {
      const canvas = document.getElementById("signaturePad");
      const ctx = canvas.getContext("2d");

      function resizeCanvas() {
        const rect = canvas.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        canvas.width = rect.width * ratio;
        canvas.height = rect.height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        ctx.fillStyle = "#000000";
        ctx.fillRect(0, 0, rect.width, rect.height);
        ctx.lineWidth = 2;
        ctx.lineCap = "round";
        ctx.strokeStyle = "#ffffff";
        signatureDirty = false;
      }

      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);

      let drawing = false;
      let lastX = 0;
      let lastY = 0;

      function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top,
          };
        } else {
          return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top,
          };
        }
      }

      function startDraw(e) {
        e.preventDefault();
        drawing = true;
        signatureDirty = true;
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
      }

      function draw(e) {
        if (!drawing) return;
        e.preventDefault();
        const pos = getPos(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
      }

      function endDraw(e) {
        if (!drawing) return;
        e.preventDefault();
        drawing = false;
      }

      canvas.addEventListener("mousedown", startDraw);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", endDraw);
      canvas.addEventListener("mouseleave", endDraw);

      canvas.addEventListener("touchstart", startDraw, { passive: false });
      canvas.addEventListener("touchmove", draw, { passive: false });
      canvas.addEventListener("touchend", endDraw, { passive: false });
      canvas.addEventListener("touchcancel", endDraw, { passive: false });

      document
        .getElementById("clearSignatureBtn")
        .addEventListener("click", (e) => {
          e.preventDefault();
          const rect = canvas.getBoundingClientRect();
          ctx.fillStyle = "#000000";
          ctx.fillRect(0, 0, rect.width, rect.height);
          signatureDirty = false;
        });
    }

    function clearSignature() {
      const canvas = document.getElementById("signaturePad");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const rect = canvas.getBoundingClientRect();
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, rect.width, rect.height);
      signatureDirty = false;
    }

    // ---- PDF ----
    function generatePdfFromForm() {
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) {
        alert("Funzione PDF non disponibile (jsPDF non caricato).");
        return;
      }

      const data = collectFormData(true);
      const doc = new jsPDF();

      let y = 15;
      doc.setFontSize(14);
      doc.text("Mainetti Solution - Bollettino intervento", 10, y);
      y += 8;

      doc.setFontSize(10);
      doc.text(`Data: ${data.date || "-"}`, 10, y);
      doc.text(`Cliente: ${data.client || "-"}`, 80, y);
      y += 6;
      doc.text(`Luogo: ${data.location || "-"}`, 10, y);
      y += 6;
      doc.text(`Collaboratore: ${data.collaborator || "-"}`, 10, y);
      y += 8;

      doc.setFontSize(11);
      doc.text("Dettagli lavoro", 10, y);
      y += 5;
      doc.setFontSize(10);
      doc.text(`Orario: ${data.startTime || "-"} ‚Üí ${data.endTime || "-"}`, 10, y);
      y += 5;
      doc.text(
        `Ore lavorate: ${data.totals.hours.toFixed(2)} h   |   Tariffa: CHF ${data.hourlyRate.toFixed(
          2
        )}/h`,
        10,
        y
      );
      y += 5;
      doc.text(`Manodopera: ${formatMoney(data.totals.laborCost)}`, 10, y);
      y += 8;

      doc.setFontSize(11);
      doc.text("Attivit√† svolta", 10, y);
      y += 5;
      doc.setFontSize(10);
      const activityLines = doc.splitTextToSize(data.activity || "-", 190);
      doc.text(activityLines, 10, y);
      y += activityLines.length * 5 + 5;

      doc.setFontSize(11);
      doc.text("Materiali", 10, y);
      y += 5;
      doc.setFontSize(10);

      if (data.materials.length) {
        doc.text("Descrizione", 10, y);
        doc.text("Q.t√†", 100, y);
        doc.text("Prezzo", 125, y);
        doc.text("Totale", 160, y);
        y += 4;
        doc.setLineWidth(0.1);
        doc.line(10, y, 200 - 10, y);
        y += 5;

        data.materials.forEach((m) => {
          if (y > 270) {
            doc.addPage();
            y = 15;
          }
          const line = doc.splitTextToSize(m.name || "Materiale", 85);
          doc.text(line, 10, y);
          doc.text(String(m.qty), 100, y);
          doc.text("CHF " + m.price.toFixed(2), 125, y);
          doc.text("CHF " + m.total.toFixed(2), 160, y);
          y += line.length * 5 + 2;
        });

        y += 3;
        doc.setFontSize(10);
        doc.text(`Totale materiali: ${formatMoney(data.totals.materialsTotal)}`, 10, y);
        y += 8;
      } else {
        doc.text("Nessun materiale inserito.", 10, y);
        y += 8;
      }

      doc.setFontSize(11);
      doc.text(`Totale intervento: ${formatMoney(data.totals.grandTotal)}`, 10, y);
      y += 10;

      if (data.notes) {
        doc.setFontSize(11);
        doc.text("Note interne", 10, y);
        y += 5;
        doc.setFontSize(10);
        const notesLines = doc.splitTextToSize(data.notes, 190);
        doc.text(notesLines, 10, y);
        y += notesLines.length * 5 + 8;
      }

      doc.setFontSize(11);
      doc.text("Firma cliente", 10, y);
      y += 5;

      if (data.signature) {
        const imgWidth = 60;
        const imgHeight = 25;
        doc.addImage(data.signature, "PNG", 10, y, imgWidth, imgHeight);
        y += imgHeight + 5;
      } else {
        doc.setFontSize(9);
        doc.text("(Firma non acquisita)", 10, y);
        y += 5;
      }

      const safeClient = (data.client || "cliente")
        .replace(/[^a-z0-9]+/gi, "-")
        .toLowerCase();
      const stamp = (data.date || "").replace(/[^0-9-]/g, "") || "oggi";

      doc.save(`bollettino-${safeClient}-${stamp}.pdf`);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const today = new Date().toISOString().slice(0, 10);
      document.getElementById("date").value = today;

      const body = document.getElementById("materialsBody");
      for (let i = 0; i < 3; i++) {
        body.appendChild(createMaterialRow());
      }

      setupSignaturePad();

      document
        .getElementById("addMaterialRow")
        .addEventListener("click", () => {
          body.appendChild(createMaterialRow());
        });

      ["startTime", "endTime", "hourlyRate"].forEach((id) => {
        document.getElementById(id).addEventListener("input", updateTotals);
      });

      document
        .getElementById("saveTicketBtn")
        .addEventListener("click", () => {
          const data = collectFormData(true);
          if (!data.client && !data.location) {
            const ok = confirm(
              "Cliente e luogo sono vuoti. Vuoi salvare comunque?"
            );
            if (!ok) return;
          }
          const tickets = loadTickets();
          tickets.push(data);
          saveTickets(tickets);
          renderTicketsList();
          document.getElementById("draftInfo").textContent = "Ultimo salvato";
        });

      document
        .getElementById("resetFormBtn")
        .addEventListener("click", () => {
        const ok = confirm("Vuoi davvero svuotare tutti i campi?");
        if (ok) resetForm();
      });

      document
        .getElementById("exportBtn")
        .addEventListener("click", exportTickets);

      document
        .getElementById("clearAllBtn")
        .addEventListener("click", () => {
          const ok = confirm(
            "Cancella tutti i bollettini salvati su questo dispositivo?"
          );
          if (!ok) return;
          localStorage.removeItem(STORAGE_KEY);
          renderTicketsList();
        });

      document
        .getElementById("generatePdfBtn")
        .addEventListener("click", generatePdfFromForm);

      // Import JSON
      const importBtn = document.getElementById("importBtn");
      const importFileInput = document.getElementById("importFileInput");

      importBtn.addEventListener("click", () => {
        importFileInput.click();
      });

      importFileInput.addEventListener("change", handleImportFile);

      updateTotals();
      renderTicketsList();

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("./service-worker.js")
          .catch((err) => console.error("SW registration failed", err));
      }
    });
  </script>
</body>
</html>
